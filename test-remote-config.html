<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>远程配置测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success {
            color: green;
        }
        .error {
            color: red;
        }
        .info {
            color: blue;
        }
        button {
            padding: 10px 15px;
            margin: 5px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .btn-primary {
            background: #007bff;
            color: white;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-warning {
            background: #ffc107;
            color: black;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>AI Shortcuts 远程配置测试</h1>
    
    <div class="test-section">
        <h2>0. 环境状态检查</h2>
        <div id="environment-status">
            <div class="info">正在检查环境状态...</div>
        </div>
    </div>
    
    <div class="test-section">
        <h2>0.5. 本地配置状态</h2>
        <button class="btn-primary" onclick="checkLocalConfig()">检查本地配置</button>
        <div id="local-config-result">
            <div class="info">点击按钮检查本地配置状态</div>
        </div>
    </div>
    
    <div class="test-section">
        <h2>1. 检查远程配置更新</h2>
        <button class="btn-primary" onclick="checkRemoteUpdate()">检查远程更新</button>
        <div id="remote-update-result"></div>
    </div>
    
    <div class="test-section">
        <h2>2. 获取当前有效配置</h2>
        <button class="btn-primary" onclick="getCurrentConfig()">获取当前配置</button>
        <div id="current-config-result"></div>
    </div>
    
    <div class="test-section">
        <h2>3. 测试站点处理器</h2>
        <button class="btn-success" onclick="testSiteHandler()">测试站点处理器</button>
        <div id="site-handler-result"></div>
    </div>
    
    <div class="test-section">
        <h2>4. 测试站点列表获取</h2>
        <button class="btn-primary" onclick="testSitesList()">测试站点列表</button>
        <div id="sites-list-result"></div>
    </div>
    
    <div class="test-section">
        <h2>5. 模拟更新配置</h2>
        <button class="btn-warning" onclick="simulateUpdate()">模拟更新</button>
        <div id="simulate-update-result"></div>
    </div>

    <script src="config/consoleConfig.js"></script>
    <script src="config/baseConfig.js"></script>
    <script>
        // 环境状态检查函数
        function checkEnvironmentStatus() {
            const statusDiv = document.getElementById('environment-status');
            let status = '';
            
            // 检查 CONFIG 对象
            if (typeof CONFIG !== 'undefined') {
                status += `<div class="success">✅ CONFIG 对象存在</div>`;
                status += `<div><strong>环境:</strong> ${CONFIG.IS_PRODUCTION ? '生产环境' : '开发环境'}</div>`;
                if (CONFIG.REMOTE_CONFIG_URL) {
                    status += `<div><strong>测试URL:</strong> ${CONFIG.REMOTE_CONFIG_URL}</div>`;
                }
            } else {
                status += `<div class="error">❌ CONFIG 对象未找到</div>`;
            }
            
            // 检查 RemoteConfigManager
            if (typeof window.RemoteConfigManager !== 'undefined') {
                status += `<div class="success">✅ RemoteConfigManager 存在</div>`;
                status += `<div><strong>配置URL:</strong> ${window.RemoteConfigManager.configUrl}</div>`;
            } else {
                status += `<div class="error">❌ RemoteConfigManager 未找到</div>`;
            }
            
            statusDiv.innerHTML = status;
        }
        
        // 检查本地配置状态
        async function checkLocalConfig() {
            const resultDiv = document.getElementById('local-config-result');
            resultDiv.innerHTML = '<div class="info">正在检查本地配置...</div>';
            
            try {
                // 检查 Chrome Storage Local
                const result = await chrome.storage.local.get([
                    'siteConfigVersion', 
                    'remoteSiteHandlers', 
                    'sites'
                ]);
                
                let status = '<div class="success">✅ 本地存储检查完成</div>';
                
                // 检查配置版本
                if (result.siteConfigVersion) {
                    status += `<div><strong>配置版本:</strong> ${result.siteConfigVersion}</div>`;
                } else {
                    status += `<div class="error">❌ 未找到配置版本</div>`;
                }
                
                // 检查远程配置数据
                if (result.remoteSiteHandlers) {
                    status += `<div class="success">✅ 远程配置数据存在</div>`;
                    status += `<div><strong>远程版本:</strong> ${result.remoteSiteHandlers.version || '未知'}</div>`;
                    status += `<div><strong>站点数量:</strong> ${result.remoteSiteHandlers.sites ? result.remoteSiteHandlers.sites.length : 0}</div>`;
                } else {
                    status += `<div class="error">❌ 未找到远程配置数据</div>`;
                }
                
                // 检查站点配置
                if (result.sites) {
                    status += `<div class="success">✅ 站点配置存在</div>`;
                    status += `<div><strong>本地站点数量:</strong> ${result.sites.length}</div>`;
                    status += `<div><strong>启用站点数量:</strong> ${result.sites.filter(s => s.enabled).length}</div>`;
                } else {
                    status += `<div class="error">❌ 未找到站点配置</div>`;
                }
                
                // 显示详细信息
                status += `<details><summary>详细信息</summary><pre>${JSON.stringify(result, null, 2)}</pre></details>`;
                
                resultDiv.innerHTML = status;
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">❌ 检查失败: ${error.message}</div>`;
            }
        }
        
        // 测试函数
        async function checkRemoteUpdate() {
            const resultDiv = document.getElementById('remote-update-result');
            resultDiv.innerHTML = '<div class="info">正在检查远程更新...</div>';
            
            try {
                if (window.RemoteConfigManager) {
                    const updateInfo = await window.RemoteConfigManager.checkAndUpdateConfig();
                    if (updateInfo.hasUpdate) {
                        resultDiv.innerHTML = `
                            <div class="success">✅ 发现新版本配置</div>
                            <pre>版本: ${updateInfo.version}</pre>
                            <pre>${JSON.stringify(updateInfo.config, null, 2)}</pre>
                        `;
                    } else {
                        resultDiv.innerHTML = '<div class="info">ℹ️ 当前已是最新版本</div>';
                    }
                } else {
                    resultDiv.innerHTML = '<div class="error">❌ RemoteConfigManager 未找到</div>';
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">❌ 检查失败: ${error.message}</div>`;
            }
        }
        
        async function getCurrentConfig() {
            const resultDiv = document.getElementById('current-config-result');
            resultDiv.innerHTML = '<div class="info">正在获取当前配置...</div>';
            
            try {
                if (window.RemoteConfigManager) {
                    const handlers = await window.RemoteConfigManager.getCurrentSiteHandlers();
                    const sites = await window.RemoteConfigManager.getCurrentSites();
                    resultDiv.innerHTML = `
                        <div class="success">✅ 当前配置获取成功</div>
                        <h4>站点处理器:</h4>
                        <pre>${JSON.stringify(handlers, null, 2)}</pre>
                        <h4>站点列表 (CN):</h4>
                        <pre>${JSON.stringify(sites, null, 2)}</pre>
                    `;
                } else {
                    resultDiv.innerHTML = '<div class="error">❌ RemoteConfigManager 未找到</div>';
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">❌ 获取失败: ${error.message}</div>`;
            }
        }
        
        async function testSiteHandler() {
            const resultDiv = document.getElementById('site-handler-result');
            resultDiv.innerHTML = '<div class="info">正在测试站点处理器...</div>';
            
            try {
                if (window.RemoteConfigManager) {
                    const handlers = await window.RemoteConfigManager.getCurrentSiteHandlers();
                    const testDomain = 'chatgpt.com';
                    const handler = handlers[testDomain];
                    
                    if (handler) {
                        resultDiv.innerHTML = `
                            <div class="success">✅ 站点处理器测试成功</div>
                            <div><strong>域名:</strong> ${testDomain}</div>
                            <div><strong>名称:</strong> ${handler.name}</div>
                            <div><strong>输入框选择器:</strong> ${handler.selectors.input}</div>
                            <div><strong>发送按钮选择器:</strong> ${handler.selectors.sendButton || '无'}</div>
                            <div><strong>处理器函数:</strong> ${typeof handler.handler === 'function' ? '✅ 函数' : '❌ 非函数'}</div>
                        `;
                    } else {
                        resultDiv.innerHTML = `<div class="error">❌ 未找到 ${testDomain} 的处理器</div>`;
                    }
                } else {
                    resultDiv.innerHTML = '<div class="error">❌ RemoteConfigManager 未找到</div>';
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">❌ 测试失败: ${error.message}</div>`;
            }
        }
        
        async function testSitesList() {
            const resultDiv = document.getElementById('sites-list-result');
            resultDiv.innerHTML = '<div class="info">正在测试站点列表获取...</div>';
            
            try {
                if (window.getDefaultSites) {
                    const sites = await window.getDefaultSites();
                    resultDiv.innerHTML = `
                        <div class="success">✅ 站点列表获取成功</div>
                        <div><strong>站点数量:</strong> ${sites.length}</div>
                        <div><strong>启用的站点:</strong> ${sites.filter(s => s.enabled).length}</div>
                        <pre>${JSON.stringify(sites, null, 2)}</pre>
                    `;
                } else {
                    resultDiv.innerHTML = '<div class="error">❌ getDefaultSites 函数未找到</div>';
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">❌ 测试失败: ${error.message}</div>`;
            }
        }
        
        async function simulateUpdate() {
            const resultDiv = document.getElementById('simulate-update-result');
            resultDiv.innerHTML = '<div class="info">正在模拟更新...</div>';
            
            try {
                if (window.RemoteConfigManager) {
                    // 模拟一个更新
                    const mockUpdateInfo = {
                        hasUpdate: true,
                        config: {
                            version: "1.0.1",
                            siteHandlers: {
                                "chatgpt.com": {
                                    name: "ChatGPT (Updated)",
                                    selectors: {
                                        input: "#prompt-textarea",
                                        sendButton: "button[data-testid=\"send-button\"]"
                                    },
                                    handler: "async function(query) { console.log('Updated handler for ChatGPT'); }"
                                }
                            }
                        },
                        version: "1.0.1"
                    };
                    
                    const result = await window.RemoteConfigManager.updateLocalConfig(mockUpdateInfo.config);
                    if (result.success) {
                        resultDiv.innerHTML = `
                            <div class="success">✅ 模拟更新成功</div>
                            <div>版本已更新到: ${mockUpdateInfo.version}</div>
                        `;
                    } else {
                        resultDiv.innerHTML = `<div class="error">❌ 更新失败: ${result.error}</div>`;
                    }
                } else {
                    resultDiv.innerHTML = '<div class="error">❌ RemoteConfigManager 未找到</div>';
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">❌ 模拟更新失败: ${error.message}</div>`;
            }
        }
        
        // 页面加载时自动运行一些测试
        window.addEventListener('load', () => {
            console.log('页面加载完成，开始自动测试...');
            console.log('CONFIG 对象:', typeof CONFIG !== 'undefined' ? CONFIG : '未找到');
            console.log('RemoteConfigManager 对象:', typeof window.RemoteConfigManager !== 'undefined' ? '存在' : '未找到');
            if (typeof window.RemoteConfigManager !== 'undefined') {
                console.log('RemoteConfigManager.configUrl:', window.RemoteConfigManager.configUrl);
            }
            
            // 先检查环境状态
            checkEnvironmentStatus();
            
            // 然后运行远程更新测试
            setTimeout(() => {
                checkRemoteUpdate();
            }, 500); // 延迟500ms确保所有脚本加载完成
        });
    </script>
</body>
</html>
